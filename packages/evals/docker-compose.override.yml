# Development overrides - automatically loaded by docker compose
# These settings only apply when running locally for development
#
# For production, use: docker compose -f docker-compose.yml up
# (explicitly exclude override file)

services:
    web:
        environment:
            - NODE_ENV=development
        volumes:
            # Mount log files so web can access task logs
            - /tmp/evals:/tmp/evals:ro
            # Mount source code for hot reload in development
            - ../../apps/web-evals:/bitx/repo/apps/web-evals:delegated
            - ../../packages/evals:/bitx/repo/packages/evals:delegated
            - ../../packages/types:/bitx/repo/packages/types:delegated
            - ../../packages/ipc:/bitx/repo/packages/ipc:delegated
            - ../../packages/cloud:/bitx/repo/packages/cloud:delegated
            # Exclude node_modules from being overwritten
            - /bitx/repo/node_modules
            - /bitx/repo/apps/web-evals/node_modules
            - /bitx/repo/packages/evals/node_modules
            - /bitx/repo/packages/types/node_modules
            - /bitx/repo/packages/ipc/node_modules
            - /bitx/repo/packages/cloud/node_modules
        entrypoint: []
        command:
            - sh
            - -c
            - |
                echo 'ğŸš€ Starting evals web service in development mode...'
                wait_for_db() {
                    echo 'â³ Waiting for database...'
                    until pg_isready -h db -p 5432 -U postgres -d evals_development > /dev/null 2>&1; do
                        echo 'â³ Database not ready yet, waiting 2 seconds...'
                        sleep 2
                    done
                    echo 'âœ… Database is ready'
                }
                wait_for_db
                echo 'ğŸ”„ Running database migrations...'
                pnpm --filter @bitx/evals db:migrate
                echo 'ğŸŒ Starting Next.js dev server...'
                cd /bitx/repo/apps/web-evals && npx next dev -p 3446
